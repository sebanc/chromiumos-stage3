#!/bin/bash

set -e

export SHELL="/bin/bash"
export LC_ALL=C

export HOME=/root
mkdir -p $HOME

env

echo -e 'FEATURES="getbinpkg"' >> /etc/portage/make.conf
emerge-webrsync
getuto

emerge --oneshot --noreplace dev-lang/go app-misc/jq net-misc/curl dev-vcs/git

chromeos_long_version=$(git ls-remote https://chromium.googlesource.com/chromiumos/third_party/kernel/ | grep "refs/heads/release-$chromeos_short_version" | head -1 | sed -e 's#.*\t##' -e 's#chromeos-.*##' | sort -u | cut -d'-' -f2,3)

echo "Entering bootstrap with ChromeOS version $chromeos_long_version"

echo -e '*/*::gentoo' > /etc/portage/package.mask/gentoo
mkdir -p /etc/portage/repos.conf
cat >/etc/portage/repos.conf/chromiumos.conf <<REPOS
[chromiumos]
location = /var/db/repos/chromiumos

[portage-stable]
location = /var/db/repos/portage-stable

[eclass-overlay]
location = /var/db/repos/eclass-overlay
REPOS
wget https://chromium.googlesource.com/chromiumos/overlays/chromiumos-overlay/+archive/refs/heads/release-$chromeos_long_version.tar.gz -O /chromiumos.tar.gz
mkdir -p /var/db/repos/chromiumos
tar zxf /chromiumos.tar.gz -C /var/db/repos/chromiumos
rm /chromiumos.tar.gz
sed -i 's@cross-x86_64-cros-linux-gnu@dev-lang@g' /var/db/repos/chromiumos/eclass/*.eclass
rm /var/db/repos/chromiumos/profiles/targets/chromeos/package.provided
rm /var/db/repos/chromiumos/profiles/targets/chromeos/package.mask
sed -i '/PATH="${dir}:${dir}\/gnu_tools/d' /var/db/repos/chromiumos/profiles/base/profile.bashrc
mv /var/db/repos/chromiumos/profiles/base/profile.bashrc /var/db/repos/chromiumos/profiles/base/profile.bashrc.tmp
sed -i '/symbolic-non-weak/d' /var/db/repos/chromiumos/dev-libs/protobuf/protobuf-*.ebuild
sed -i 's@cipd://gn/gn/linux-amd64:@https://chrome-infra-packages.appspot.com/dl/gn/gn/linux-amd64/+/@g' /var/db/repos/chromiumos/dev-util/gn/gn-*.ebuild
sed -i 's@\[\[ "${CTARGET}" == "${CHOST}" ]]@false@g' /var/db/repos/chromiumos/sys-devel/gcc/gcc-*.ebuild
sed -i '/-name install-tools -prune/d' /var/db/repos/chromiumos/sys-devel/gcc/gcc-*.ebuild
sed -i 's@$(portageq envvar CFLAGS)@@g' /var/db/repos/chromiumos/sys-devel/gcc/gcc-*.ebuild
sed -i -z 's@eapply "${WORKDIR}/patch"@eapply "${WORKDIR}/patch"\n\teapply "${FILESDIR}/libcpp-enable-nls.patch"@g' /var/db/repos/chromiumos/sys-devel/gcc/gcc-*.ebuild
wget https://chromium.googlesource.com/chromiumos/overlays/portage-stable/+archive/refs/heads/release-$chromeos_long_version.tar.gz -O /portage-stable.tar.gz
mkdir -p /var/db/repos/portage-stable
tar zxf /portage-stable.tar.gz -C /var/db/repos/portage-stable
rm /portage-stable.tar.gz
sed -i 's@$(usev pgo.*@""@g' /var/db/repos/portage-stable/app-arch/xz-utils/xz-utils-*.ebuild
sed -i '/virtual\/perl-Math-BigInt/d' /var/db/repos/portage-stable/dev-lang/perl/perl-*.ebuild
sed -i 's@$(usev !system /xcrypt)@@g' /var/db/repos/portage-stable/sys-libs/libxcrypt/libxcrypt-*.ebuild
wget https://chromium.googlesource.com/chromiumos/overlays/eclass-overlay/+archive/refs/heads/release-$chromeos_long_version.tar.gz -O /eclass-overlay.tar.gz
mkdir -p /var/db/repos/eclass-overlay
tar zxf /eclass-overlay.tar.gz -C /var/db/repos/eclass-overlay
rm /eclass-overlay.tar.gz
rm /etc/portage/make.profile
chromeos_profile_version=$(basename $(find /var/db/repos/chromiumos/profiles/default/linux/amd64/* -maxdepth 0 -type d | tail -1))
echo "Using ChromeOS profile version $chromeos_profile_version"
sed -i '/features\/llvm/d' /var/db/repos/chromiumos/profiles/default/linux/amd64/$chromeos_profile_version/chromeos/parent
ln -s /var/db/repos/chromiumos/profiles/default/linux/amd64/$chromeos_profile_version/chromeos /etc/portage/make.profile
sed -i '/^FEATURES=/d' /etc/portage/make.conf
cat >>/etc/portage/make.conf <<'MAKEDEFAULTS'
FEATURES="-buildpkg -collision-detect -force-mirror -getbinpkg -protect-owned -sandbox -splitdebug"
GENTOO_MIRRORS="https://storage.googleapis.com/chromeos-mirror/gentoo"
USE="-debug -doc -llvm_pgo_use -pam -pgo_use -test -thinlto"
CROS_ARTIFACTS_TMP_DIR="/tmp/cros_artifacts"
PORTDIR="/var/cache"
MAKEDEFAULTS
mkdir -p /etc/portage/profile/package.use /etc/portage/profile/package.use.force
echo -e 'sys-libs/glibc static-pie' > /etc/portage/profile/package.use/glibc
echo -e 'sys-libs/libxcrypt static-libs' > /etc/portage/profile/package.use/libxcrypt
echo 'sys-devel/gcc -multilib' > /etc/portage/profile/package.use.force/gcc
rm -r /var/db/pkg

USE="headers-only" emerge --nodeps sys-devel/automake dev-lang/python sys-libs/glibc sys-devel/binutils dev-libs/gmp dev-libs/mpfr dev-libs/mpc dev-libs/libffi sys-devel/gcc dev-build/libtool sys-libs/libsepol sys-libs/libselinux sys-libs/ncurses
. /etc/profile
mv /var/db/repos/chromiumos/profiles/base/profile.bashrc.tmp /var/db/repos/chromiumos/profiles/base/profile.bashrc

LDFLAGS="-L/bootstrap/lib64 -L/bootstrap/usr/lib64 -lncursesw" ROOT="/bootstrap" SYSROOT="/bootstrap" emerge --select --nodeps sys-apps/baselayout sys-kernel/linux-headers sys-libs/glibc sys-devel/binutils dev-libs/gmp dev-libs/mpfr dev-libs/mpc dev-libs/libffi sys-devel/gcc sys-devel/automake dev-build/libtool sys-libs/zlib sys-libs/ncurses app-arch/xz-utils app-arch/bzip2 sys-devel/gnuconfig sys-apps/attr dev-libs/expat sys-libs/libxcrypt app-misc/mime-types dev-lang/python-exec-conf dev-python/ensurepip-pip dev-python/ensurepip-setuptools sys-libs/timezone-data dev-libs/libunistring sys-libs/libsepol sys-apps/mawk sys-devel/automake-wrapper sys-devel/autoconf-wrapper app-misc/pax-utils sys-apps/install-xattr dev-libs/popt dev-util/pkgconf dev-lang/python-exec app-arch/zstd dev-libs/libedit dev-python/ensurepip-wheels app-alternatives/awk dev-libs/libltdl sys-devel/m4 sys-apps/sandbox sys-apps/file sys-libs/readline dev-libs/libpcre2 sys-apps/grep app-portage/portage-utils sys-libs/libselinux sys-libs/gdbm sys-apps/util-linux sys-apps/coreutils sys-apps/findutils sys-apps/gentoo-functions sys-devel/gcc-config sys-devel/binutils-config net-dns/libidn2 app-shells/bash dev-lang/perl sys-devel/autoconf dev-libs/openssl app-arch/tar app-alternatives/tar app-misc/ca-certificates sys-apps/sed dev-libs/libxml2 app-crypt/libb2 dev-lang/python dev-libs/oniguruma app-misc/jq app-admin/eselect net-misc/rsync sys-apps/portage app-admin/perl-cleaner sys-libs/libxcrypt app-arch/gzip app-alternatives/gzip sys-apps/locale-gen dev-lang/go app-admin/sudo net-misc/wget sys-devel/patch sys-devel/make sys-devel/flex app-arch/unzip sys-devel/bison app-alternatives/yacc app-portage/elt-patches sys-apps/diffutils sys-apps/gawk sys-apps/texinfo app-portage/gentoolkit
cp /bootstrap/usr/share/baselayout/* /bootstrap/etc/

LDFLAGS="-L/bootstrap/lib64 -L/bootstrap/usr/lib64 -lncursesw" ROOT="/bootstrap" SYSROOT="/bootstrap" emerge --select dev-python/tomli dev-python/installer dev-python/gpep517 dev-python/flit-core dev-python/packaging dev-python/more-itertools dev-python/platformdirs dev-python/trove-classifiers dev-python/typing-extensions dev-python/backports-tarfile dev-python/wheel dev-python/jaraco-context dev-python/jaraco-functools dev-python/jaraco-text dev-python/setuptools dev-python/setuptools-scm

rm -rf /bootstrap/etc/portage
cp -r /etc/portage /bootstrap/etc/
rm /bootstrap/etc/portage/package.mask/gentoo
rm -rf /bootstrap/var/db/repos
cp -r /var/db/repos /bootstrap/var/db/
rm -rf /bootstrap/var/db/repos/gentoo

LDFLAGS="-L/bootstrap/lib64 -L/bootstrap/usr/lib64 -lncursesw" ROOT="/bootstrap" SYSROOT="/bootstrap" emerge --nodeps @world

cp /bootstrap/usr/share/baselayout/* /bootstrap/etc/
echo 'chronos:x:1000:1000:chronos:/home/chronos:/bin/bash' >> /bootstrap/etc/passwd
echo 'chronos:x:1000:chronos' >> /bootstrap/etc/group
echo 'chronos ALL=(ALL) NOPASSWD: ALL' > /bootstrap/etc/sudoers.d/95_cros_base
echo 'nameserver 1.1.1.1' > /bootstrap/etc/resolv.conf

mkdir -p /bootstrap/proc /bootstrap/sys /bootstrap/dev

mount -t proc none /bootstrap/proc
mount --bind -o ro /sys /bootstrap/sys
mount --make-slave /bootstrap/sys
mount --bind /dev /bootstrap/dev
mount --make-slave /bootstrap/dev
mount --bind /dev/pts /bootstrap/dev/pts
mount --make-slave /bootstrap/dev/pts
mount -t tmpfs -o mode=1777 none /bootstrap/dev/shm

cp /stage2 /bootstrap/init
chromeos_long_version=$chromeos_long_version chroot --userspec=1000:1000 /bootstrap /init
rm -f /bootstrap/init
echo '' > /bootstrap/.finished

for ROOT in $(find /proc/*/root 2>/dev/null); do
	LINK="$(readlink -f ${ROOT})"
	if echo "${LINK}" | grep -q /bootstrap; then
		PID=$(basename $(dirname "${ROOT}"))
		kill -STOP ${PID} 2>/dev/null
	fi
done
sleep 2
for ROOT in $(find /proc/*/root 2>/dev/null); do
	LINK="$(readlink -f ${ROOT})"
	if echo "${LINK}" | grep -q /bootstrap; then
		PID=$(basename $(dirname "${ROOT}"))
		kill -9 ${PID} 2>/dev/null
	fi
done
sleep 5

if mountpoint -q /bootstrap/dev/shm; then umount /bootstrap/dev/shm; fi
if mountpoint -q /bootstrap/dev/pts; umount /bootstrap/dev/pts; fi
if mountpoint -q /bootstrap/dev; then umount /bootstrap/dev; fi
if mountpoint -q /bootstrap/sys; then umount /bootstrap/sys; fi
if mountpoint -q /bootstrap/proc; then umount /bootstrap/proc; fi

